<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receipt Loader</title>
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<style>
  body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
  .container { max-width: 700px; margin: auto; }
  .receipt-container { 
    max-width: 600px; 
    margin: auto; 
    background: #fff; 
    border: 1px solid #ddd; 
    padding: 20px; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .loading { text-align: center; color: #666; padding: 40px; }
  
  /* Print-specific styles */
  @media print {
    body { margin: 0; padding: 0; background: white; }
    .container { max-width: none; }
    .receipt-container { 
      max-width: none; 
      margin: 0; 
      border: none; 
      padding: 20px;
      box-shadow: none;
    }
    @page { margin: 0.5in; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="receipt-container" id="receipt">
    <div class="loading">Loading receipt...</div>
  </div>
</div>

<script>
// Helper: get URL parameters
function getParams() {
  const search = new URLSearchParams(window.location.search);
  return {
    data: search.get('data') || '',
    print: search.get('print') === 'true'
  };
}

// Enhanced decode function
function decodeCompressedHTML(data) {
  try {
    let decodedData = data;
    try {
      const urlDecoded = decodeURIComponent(data);
      if (urlDecoded !== data) {
        decodedData = urlDecoded;
      }
    } catch (e) {
      // Continue with original data
    }
    
    const base64Decoded = atob(decodedData);
    
    if (base64Decoded.startsWith('<!DOCTYPE html>') || base64Decoded.startsWith('<html')) {
      return base64Decoded;
    }
    
    try {
      const decompressed = pako.inflate(base64Decoded, { to: 'string' });
      return decompressed;
    } catch (pakoError) {
      return base64Decoded;
    }
    
  } catch(e) {
    return '<p style="color: red;">Error decoding receipt data. Please check the URL format.</p>';
  }
}

// Render receipt
function renderReceipt() {
  const params = getParams();
  const container = document.getElementById('receipt');
  
  if (params.data) {
    try {
      const decodedHTML = decodeCompressedHTML(params.data);
      container.innerHTML = decodedHTML;
      
      // Auto-print if requested
      if (params.print) {
        setTimeout(() => {
          window.print();
        }, 500);
      }
    } catch(e) {
      container.innerHTML = '<p style="color: red;">Error rendering receipt</p>';
    }
  } else {
    container.innerHTML = '<p>No receipt data provided. Add ?data=yourBase64Data to the URL.</p>';
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  renderReceipt();
});

window.addEventListener('load', function() {
  renderReceipt();
});
</script>
</body>
</html>
